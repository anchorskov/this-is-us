# BULLETED SUMMARY ‚Äì Town Hall D1 Alignment Complete

**For**: Jimmy, Codex
**Date**: December 9, 2025
**Status**: ‚úÖ READY FOR CODEX IMPLEMENTATION

---

## üéØ What Was Done

### Code & Infrastructure Fixes
- ‚úÖ **Fixed listPosts.js** ‚Äì Removed references to non-existent `county_name` and `topic_slug` columns; added actual columns `city` and `state` to SELECT and response
- ‚úÖ **Fixed createPost.js** ‚Äì Added capture of `city` and `state` form fields; included them in INSERT statement so location data persists to database
- ‚úÖ **Created migration 0016** ‚Äì `worker/migrations/0016_create_townhall_posts.sql` ‚Äì Ensures townhall_posts table exists on local, preview, and future environments (not just production)
- ‚úÖ **Updated snapshot** ‚Äì `documentation/thisisus_snapshot_120625.md` ‚Äì Added Town Hall API details and column documentation

### Infrastructure Status
- ‚úÖ **townhall_posts table exists** in EVENTS_DB (production) with 10 columns: id, user_id, title, prompt, created_at, r2_key, file_size, expires_at, city, state
- ‚úÖ **GET /api/townhall/posts** endpoint functional ‚Äì Returns JSON array of recent threads with limit/pagination
- ‚úÖ **POST /api/townhall/create** endpoint functional ‚Äì Creates thread from form data; requires Firebase ID token
- ‚úÖ **R2 file upload working** ‚Äì Files uploaded to Cloudflare R2 bucket; expire in 90 days
- ‚úÖ **Auth verified** ‚Äì Firebase token verification middleware integrated

---

## üìä D1 Schema (Final)

```
Table: townhall_posts (EVENTS_DB)
‚îú‚îÄ id (TEXT PRIMARY KEY) ‚Äì UUID, generated by POST
‚îú‚îÄ user_id (TEXT NOT NULL) ‚Äì Firebase UID, from auth token
‚îú‚îÄ title (TEXT NOT NULL) ‚Äì Thread title, from form (required)
‚îú‚îÄ prompt (TEXT) ‚Äì Initial message, from form (optional)
‚îú‚îÄ created_at (TEXT NOT NULL) ‚Äì ISO timestamp, auto-generated
‚îú‚îÄ r2_key (TEXT) ‚Äì File reference if PDF uploaded (optional)
‚îú‚îÄ file_size (INTEGER) ‚Äì Byte size of file
‚îú‚îÄ expires_at (TEXT) ‚Äì ISO timestamp (90 days from creation)
‚îú‚îÄ city (TEXT DEFAULT '') ‚Äì From form (optional)
‚îî‚îÄ state (TEXT DEFAULT '') ‚Äì From form (optional)

Indices:
‚îú‚îÄ idx_townhall_posts_created_at ‚Äì For pagination queries
‚îî‚îÄ idx_townhall_posts_city ‚Äì For location-based filtering
```

---

## üîå API Endpoints (Ready)

### GET /api/townhall/posts
- **Purpose**: Fetch recent threads (public)
- **Query params**: `limit` (3‚Äì10, default 3), `after` (ISO timestamp, optional)
- **Response**: JSON with thread list including city, state, file metadata
- **Example**: `GET /api/townhall/posts?limit=5`
- **Status**: ‚úÖ Working

### POST /api/townhall/create
- **Purpose**: Create new thread (authenticated)
- **Auth**: Bearer token (Firebase ID token)
- **Form fields**: title (required), prompt (optional), city (optional), state (optional), file (optional, max 2 MB)
- **Response**: 201 `{ "success": true }` on success; 400/500 errors with message
- **Status**: ‚úÖ Working (after code fixes)

---

## üìã For Codex: Create-Thread.js Implementation

### Form Fields to Capture
- [ ] `title` (text input, required) ‚Äì Thread topic
- [ ] `prompt` (textarea, optional) ‚Äì User's thoughts/message
- [ ] `city` (text input, optional) ‚Äì Where they're from
- [ ] `state` (text input or select, optional) ‚Äì State (default Wyoming)
- [ ] `file` (file upload, optional) ‚Äì Supporting document (max 2 MB, PDF preferred)

### POST Request Pattern
```javascript
const formData = new FormData();
formData.append('title', document.getElementById('title').value);
formData.append('prompt', document.getElementById('prompt').value);
formData.append('city', document.getElementById('city').value);
formData.append('state', document.getElementById('state').value);
if (document.getElementById('file').files.length > 0) {
  formData.append('file', document.getElementById('file').files[0]);
}

const response = await fetch('/api/townhall/create', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${await firebase.auth().currentUser.getIdToken()}`
  },
  body: formData
});

const result = await response.json();
if (response.ok) {
  // 201 success ‚Äì show message, refresh thread list
} else {
  // 400/500 error ‚Äì show result.error to user
}
```

### Remove Old Code
- [ ] Delete Firestore `addDoc(collection(db, 'townhall_threads'), {...})` call
- [ ] Delete Firestore permission error handling
- [ ] Keep Firebase Auth (still used for token)

### Testing Checklist
- [ ] Manual form submission (desktop, mobile)
- [ ] File upload (with and without file)
- [ ] Network tab ‚Äì verify POST request + 201 response
- [ ] GET /api/townhall/posts shows new thread
- [ ] City/state displayed in thread list

---

## üöÄ Local Development Commands

### Apply Migration
```bash
cd /home/anchor/projects/this-is-us/worker
npx wrangler d1 migrations apply EVENTS_DB --local
```

### Verify Table
```bash
npx wrangler d1 execute EVENTS_DB --local --command "PRAGMA table_info(townhall_posts);"
```

### Insert Test Data
```bash
npx wrangler d1 execute EVENTS_DB --local --command \
  "INSERT INTO townhall_posts (id, user_id, title, prompt, created_at, city, state) \
   VALUES ('test-uuid', 'test-uid', 'Test Thread', 'Test message', datetime('now'), 'Cheyenne', 'Wyoming');"
```

### Start Worker
```bash
cd /home/anchor/projects/this-is-us/worker
npx wrangler dev --local
```

### Test GET Endpoint
```bash
curl -s "http://127.0.0.1:8787/api/townhall/posts?limit=3" | jq
```

### Test POST Endpoint
```bash
# 1. Get Firebase ID token from browser console (after login)
# 2. Export it: export FIREBASE_ID_TOKEN="<token>"
# 3. Test:

curl -X POST http://127.0.0.1:8787/api/townhall/create \
  -H "Authorization: Bearer $FIREBASE_ID_TOKEN" \
  -F "title=Test Thread" \
  -F "prompt=Testing location capture" \
  -F "city=Cheyenne" \
  -F "state=Wyoming"
```

Expected response: `{ "success": true }` (201 Created) ‚úÖ

---

## ‚úÖ Alignment Verification

| Component | Status | Notes |
|-----------|--------|-------|
| D1 table exists | ‚úÖ YES | townhall_posts in EVENTS_DB |
| Table schema correct | ‚úÖ YES | 10 columns, matches docs |
| Migration file exists | ‚úÖ YES | 0016_create_townhall_posts.sql |
| listPosts.js code | ‚úÖ FIXED | Uses city/state (not county_name/topic_slug) |
| createPost.js code | ‚úÖ FIXED | Captures and stores city/state |
| GET /api/townhall/posts | ‚úÖ WORKS | Returns correct JSON |
| POST /api/townhall/create | ‚úÖ WORKS | Creates threads with location |
| Snapshot documentation | ‚úÖ UPDATED | Town Hall API section added |
| Codex ready? | ‚úÖ YES | Clear form/POST pattern documented |

---

## üìö Reference Documents

In workspace (`/home/anchor/projects/this-is-us/`):
- **TOWNHALL_D1_ALIGNMENT_REVIEW.md** ‚Äì Complete technical analysis (everything included)
- **TOWNHALL_D1_SUMMARY_FOR_JIMMY.md** ‚Äì Detailed guide with commands and examples
- **documentation/thisisus_snapshot_120625.md** ‚Äì Updated snapshot

In Downloads folder:
- **TOWNHALL_CREATE_CODE_REFERENCE.md** ‚Äì Before/after code for create-thread.js
- **TOWNHALL_CREATE_DESIGN.md** ‚Äì Full spec with Jest test cases

---

## ‚ö†Ô∏è Key Implementation Notes

1. **City/state capture** ‚Äì Now required in form to populate; optional for user but form should include fields
2. **File expiry** ‚Äì Automatic (90 days); no frontend action needed
3. **Auth required** ‚Äì POST requires Firebase ID token; GET is public
4. **Public data** ‚Äì Town Hall threads are publicly readable; no permission checks
5. **Error handling** ‚Äì POST returns 400 (client error) or 500 (server error) with message in JSON

---

## üü¢ Status: READY FOR CODEX

All infrastructure, code fixes, and documentation complete. Codex can now:
1. Update `create-thread.js` to POST instead of Firestore
2. Add city/state form fields
3. Handle 201/400/500 responses
4. Test with migration applied locally
5. Deploy to production

**Expected effort**: ~1‚Äì2 hours (form + POST logic + testing)

---

## Questions?

See **TOWNHALL_D1_SUMMARY_FOR_JIMMY.md** (in workspace) for:
- Detailed API specs with example requests/responses
- Command-line testing procedures
- Migration verification steps
- Integration questions for Codex

