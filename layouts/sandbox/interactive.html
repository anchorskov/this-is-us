{{/* layouts/sandbox/interactive.html */}}

{{ define "main" }}
<div
  x-data="sandboxFlow()"
  x-cloak
  class="max-w-2xl mx-auto p-6"
>
  <h1 class="text-3xl font-bold mb-6">ğŸ§  Six Second Interactive Sandbox</h1>

  <!-- Stage 0 -->
  <template x-if="stage === 0">
    <div>
      <label class="block mb-2 font-semibold">
        ğŸ“¥ Paste your meme, message, or post:
      </label>
      <textarea
        x-model="input"
        class="w-full h-32 p-4 border rounded mb-4"
        placeholder="Paste content hereâ€¦"
      ></textarea>
      <button
        @click="nextStage()"
        :disabled="!input.trim()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        âœ¨ Start Reflection â†’
      </button>
    </div>
  </template>

  <!-- Questions 1â€“5 -->
  <template x-if="stage > 0 && stage <= questions.length">
    <div class="mt-6">
      <h2 class="font-semibold text-lg mb-2">
        ğŸ“ Step <span x-text="stage"></span> of <span x-text="questions.length"></span>
      </h2>
      <p class="mb-4" x-text="questions[stage - 1].prompt"></p>
      <textarea
        x-model="answers[stage - 1]"
        class="w-full h-28 p-4 border rounded mb-4"
        placeholder="Your reflectionâ€¦"
      ></textarea>
      <div class="flex justify-between">
        <button @click="prevStage()" class="text-gray-500">â† Back</button>
        <button
          @click="nextStage()"
          :disabled="!answers[stage - 1].trim()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Next â†’
        </button>
      </div>
    </div>
  </template>

  <!-- AI Response -->
  <template x-if="stage === questions.length + 1">
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">ğŸ”„ Generating Your Reflectionâ€¦</h2>
      <div x-show="loading" class="text-sm text-gray-500">ğŸ¤– Working with AIâ€¦</div>
      <div x-show="error" class="text-red-500 mb-4" x-text="error"></div>
      <div
        x-show="reflection"
        class="space-y-4 p-4 bg-blue-50 border rounded shadow"
      >
        <h3 class="font-semibold text-blue-700">ğŸ’¡ Suggested Response:</h3>
        <template x-for="line in reflection.split('\n\n')" :key="line">
          <p class="text-blue-800" x-text="line"></p>
        </template>
      </div>
      <button
        @click="restart()"
        class="mt-4 text-blue-600 hover:underline"
      >ğŸ” Start over</button>
    </div>
  </template>
</div>
{{ end }}

{{ define "scripts" }}
  <!-- Sandbox-only API base URL -->
  <script>
    const host = window.location.hostname;
    const port = window.location.port;
    window.EVENTS_API_URL = (host === 'localhost' && port === '1313')
      ? `${window.location.protocol}//${host}:8787/api`
      : '/api';
    console.log("ğŸ› Sandbox using EVENTS_API_URL â†’", window.EVENTS_API_URL);
  </script>

  <!-- Define sandboxFlow BEFORE Alpine loads -->
  <script>
    function sandboxFlow() {
      return {
        stage:      0,
        input:      '',
        answers:    ['', '', '', '', ''],
        reflection: '',
        loading:    false,
        error:      '',
        questions: [
          { prompt: 'What emotions arise for you here?' },
          { prompt: 'What is the message or claim in this statement?' },
          { prompt: 'Who does this serve?' },
          { prompt: 'Whatâ€™s missing or needs clarification?' },
          { prompt: 'What would you like to say in return?' }
        ],

        nextStage() {
          if (this.stage < this.questions.length) {
            this.stage++;
          } else {
            // â¡ï¸ All answers collectedâ€”dump them
            console.log("âœ… All answers collected:", this.answers);
            this._generate();
            this.stage++;
          }
        },

        prevStage() {
          if (this.stage > 0) this.stage--;
        },

        restart() {
          this.stage      = 0;
          this.input      = '';
          this.answers    = ['', '', '', '', ''];
          this.reflection = '';
          this.error      = '';
        },

        async _generate() {
          // â¡ï¸ Prepare and log the AI payload
          const payload = {
            prompt:
              `${this.input}\n\nReflection:\n` +
              this.answers.map((a, i) => `Q${i + 1}: ${a}`).join('\n')
          };
          console.log("ğŸ” Sending to AI:", payload);

          this.loading = true;
          this.error   = '';
          try {
            const res = await fetch(`${window.EVENTS_API_URL}/sandbox/analyze`, {
              method:  'POST',
              headers: { 'Content-Type': 'application/json' },
              body:    JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(res.statusText);

            const data = await res.json();
            // â¡ï¸ Log whatever the AI sent back
            console.log("ğŸ’¡ AI responded:", data.message);

            if (data.error) throw new Error(data.error);
            this.reflection = data.message;
          } catch (err) {
            console.error("âŒ AI error:", err);
            this.error = err.message || 'Something went wrong.';
          } finally {
            this.loading = false;
          }
        }
      };
    }
  </script>

  <!-- Load Alpine synchronously so sandboxFlow() is available immediately -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
  <script>
    console.log("âœ… Alpine loaded (inline):", typeof Alpine !== "undefined");
  </script>
{{ end }}
