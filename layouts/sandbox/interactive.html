{{/* layouts/sandbox/interactive.html */}}

{{ define "header" }}
  <!-- Interactive-Enhanced Six Second Sandbox -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>[x-cloak] { display: none; }</style>
{{ end }}

{{ define "main" }}
<div class="max-w-2xl mx-auto p-6" x-data="sandboxFlow()">
  <h1 class="text-3xl font-bold mb-6">🧠 Six Second Interactive Sandbox</h1>

  <!-- Stage 0: Initial input -->
  <div x-show="stage === 0" x-cloak>
    <label class="block font-semibold mb-2">📥 Paste your meme, message, or post:</label>
    <textarea
      x-model="input"
      class="w-full h-32 p-4 border border-gray-300 rounded text-lg text-gray-800 bg-white mb-4"
      placeholder="Paste content here..."
    ></textarea>
    <button
      @click="nextStage"
      :disabled="!input.trim()"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >✨ Start Reflection →</button>
  </div>

  <!-- Stages 1–5: Questions -->
  <div x-show="stage > 0 && stage <= questions.length" x-cloak>
    <h2
      class="font-semibold text-lg mb-2 text-gray-700"
      x-text="'📝 Step ' + stage + ' of ' + questions.length"
    ></h2>
    <p class="mb-4 text-gray-700" x-text="questions[stage - 1].prompt"></p>
    <textarea
      x-model="answers[stage - 1]"
      class="w-full h-28 p-4 border border-gray-300 rounded text-lg text-gray-800 bg-white mb-4"
      placeholder="Your reflection..."
    ></textarea>
    <div class="flex justify-between">
      <button @click="prevStage" class="text-gray-500">← Back</button>
      <button
        @click="nextStage"
        :disabled="!answers[stage - 1].trim()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >Next →</button>
    </div>
  </div>

  <!-- Final Stage: Generating response -->
  <div x-show="stage === questions.length + 1" x-cloak>
    <h2 class="text-xl font-bold mb-2">🔄 Generating Your Reflection...</h2>
    <div x-show="loading" class="text-sm text-gray-500">🤖 Working with AI...</div>
    <div x-show="error" class="text-red-500 mt-2" x-text="error"></div>
    <div
      x-show="reflection"
      class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded shadow"
    >
      <h3 class="font-semibold mb-2 text-blue-700">💡 Suggested Response:</h3>
      <div class="space-y-4 text-blue-800 text-base">
        <template x-for="line in reflection.split('\\n\\n')" :key="line">
          <p x-text="line"></p>
        </template>
      </div>
    </div>
    <button @click="restart" class="mt-4 text-sm text-blue-600">🔁 Start over</button>
  </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
  function sandboxFlow() {
    return {
      stage: 0,
      input: '',
      answers: ['', '', '', '', ''],
      reflection: '',
      loading: false,
      error: '',
      questions: [
        { prompt: 'What emotions arise for you here?' },
        { prompt: 'What is the message or claim in this statement?' },
        { prompt: 'Who does this serve, and why might they want this information spread?' },
        { prompt: 'What’s missing or needs clarification about this claim?' },
        { prompt: 'What would you like to say in return?' }
      ],

      nextStage() {
        if (this.stage === this.questions.length) {
          this.generateReflection();
        }
        if (this.stage < this.questions.length + 1) {
          this.stage++;
        }
      },

      prevStage() {
        if (this.stage > 0) this.stage--;
      },

      restart() {
        this.stage = 0;
        this.input = '';
        this.answers = ['', '', '', '', ''];
        this.reflection = '';
        this.error = '';
      },

      async generateReflection() {
        this.loading = true;
        this.error = '';

        const payload = {
          prompt:
            `${this.input}\n\nReflection:\n` +
            this.answers.map((a, i) => `Q${i + 1}: ${a}`).join('\n')
        };

        try {
          const res = await fetch(
            'https://this-is-us-events.anchorskov.workers.dev/sandbox/analyze',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }
          );
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          this.reflection = data.message;
        } catch (err) {
          this.error = err.message || 'Something went wrong.';
        } finally {
          this.loading = false;
        }
      }
    };
  }
</script>
{{ end }}
