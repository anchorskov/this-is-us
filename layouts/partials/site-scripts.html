{{- /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     File: layouts/partials/site-scripts.html
     Injected right before </body>.
     Only assets that truly belong at the end of the page go here.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */ -}}

{{/* 1ï¸âƒ£ Dynamic API root (dev â‡† prod â‡† local-worker) */}}
<script>
(function () {
  let resolveApiReady;
  window.EVENTS_API_READY = new Promise((r) => (resolveApiReady = r));

  const host   = location.hostname;
  const port   = location.port;
  const isLocalHost = host === 'localhost' || host === '127.0.0.1' || host === '::1';
  const onHugoServer = isLocalHost && port === '1313';

  const params          = new URLSearchParams(location.search);
  const localPref       = localStorage.getItem('useLocalWorker');
  const enabledViaQuery = params.get('useLocalWorker'); // "1" | "0" | null

  if (enabledViaQuery === '1') {
    localStorage.setItem('useLocalWorker', '1');
  } else if (enabledViaQuery === '0') {
    localStorage.removeItem('useLocalWorker');
  }

  // Default to local probe whenever we're on localhost/127 and the user
  // hasn't explicitly disabled it with ?useLocalWorker=0.
  const shouldProbeLocal =
    isLocalHost &&
    enabledViaQuery !== '0' &&
    (enabledViaQuery === '1' || localPref === '1' || onHugoServer);

  /* default:
       â€“ prod build / worker origin â†’ /api (same origin)
       â€“ hugo server â†’ remote Worker on production (will switch if local probe succeeds) */
  window.EVENTS_API_URL = onHugoServer
    ? 'https://this-is-us.org/api'
    : '/api';
  let resolved = false;

  /* local Worker probe (wrangler dev --port 8787) */
  if (shouldProbeLocal) {
    const local = 'http://127.0.0.1:8787';
    fetch(local + '/api/_health')
      .then((res) => {
        if (res.ok) {
          window.EVENTS_API_URL = local + '/api';
          console.log('ğŸ”„ Local Worker detected â€“ API â†’', window.EVENTS_API_URL);
          resolveApiReady && resolveApiReady(window.EVENTS_API_URL);
          resolved = true;
        } else {
          console.log('ğŸ› Local Worker probe responded', res.status, 'â€” staying on', window.EVENTS_API_URL);
        }
      })
      .catch(() => {
        console.log('ğŸ› Local Worker probe failed â€” using', window.EVENTS_API_URL);
      });
  } else {
    if (onHugoServer) {
      console.log('ğŸ› Skipping local Worker probe (enable with ?useLocalWorker=1)');
    }
    console.log('ğŸŒ Using API â†’', window.EVENTS_API_URL);
  }

  // Resolve promise after a short tick if not already resolved
  setTimeout(() => {
    if (!resolved) resolveApiReady && resolveApiReady(window.EVENTS_API_URL);
  }, 50);
})();
</script>

{{/* Quick helpers */}}
{{- $rp         := .RelPermalink -}}
{{- $isTownHall := strings.HasPrefix $rp "/townhall" -}}

{{/* 2ï¸âƒ£ Town-Hall page bundles (ES-modules) */}}
{{- if eq $rp "/townhall/map/"     }}<script type="module" src="/js/townhall/map.js"     defer></script>{{ end }}
{{- if eq $rp "/townhall/threads/" }}<script type="module" src="/js/townhall/threads.js" defer></script>{{ end }}
{{- if eq $rp "/townhall/create/"  }}<script type="module" src="/js/townhall/create.js"  defer></script>{{ end }}

{{/* NOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   home.js is NOT included here because layouts/section/townhall.html
   injects it via its own {{ define "scripts" }} block, with the
   correct `type="module"`. Including it twice caused the earlier
   â€œCannot use import statement outside a moduleâ€ error.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/}}

{{/* 3ï¸âƒ£  No Firebase helpers here.
        firebase-init.html (included once in baseof.html) already
        loads:
          âœ“ firebase-config.js   âœ“ firebase-login.js
          âœ“ firebase-session.js  âœ“ firebase-ui-config.js
        Keeping it single-source avoids the â€œFirebase is already
        defined in the global scopeâ€ warning. */}}
{{ if in .RelPermalink "/account" }}
  <script type="module" src="/js/account.js"></script>
{{ end }}
