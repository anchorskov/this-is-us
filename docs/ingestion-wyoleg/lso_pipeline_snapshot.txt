================================================================================
LSO PIPELINE SNAPSHOT
Generated: December 16, 2025
================================================================================

FILE 1: INGESTION_TODO_NEXT.md
================================================================================

# Wyoming LSO Ingestion: Next Actions

Ordered, high-impact tasks with validation commands.

1) Apply local migrations with persistence
   - `cd worker && ./scripts/apply-migrations-local.sh`
   - Validate: `XDG_CONFIG_HOME=./.config ./scripts/wr d1 execute WY_DB --local --persist-to ../scripts/wr-persist --command "SELECT name FROM d1_migrations;" --json`

2) Ensure single persist dir in dev runs
   - Start via `./start_local.sh` (uses --persist-to ./scripts/wr-persist).
   - Validate: `find scripts/wr-persist -name "*.sqlite"`

3) Run full wyoleg pipeline locally (fresh)
   - `cd worker && ./scripts/test-wyoleg-pipeline-local.sh --reset`
   - Validate: script reports summaries/tags > 0 and civic_item_sources populated.

4) Audit ingestion state
   - `cd worker && ./scripts/audit-wyoleg-ingestion.sh`
   - Validate: report shows required tables present and counts (bills, sources, summaries, tags).

5) Hot-topics linkage sanity
   - If needed, seed hot_topic_civic_items with current bills (manual/SQL).
   - Validate: `./scripts/wr d1 execute EVENTS_DB --local --persist-to ../scripts/wr-persist --command "SELECT COUNT(*) FROM hot_topic_civic_items;" --json`

6) Remote schema parity check
   - `cd worker && XDG_CONFIG_HOME=./.config ./scripts/wr d1 migrations list WY_DB --remote`
   - Validate: compare against local `d1_migrations`; apply if missing.

7) Doc resolver spot check
   - `cd worker && BILL=SF0013 YEAR=2026 DEBUG=1 ./scripts/test-doc-resolver-local.sh`
   - Validate: output shows best URL ending in Introduced/Enroll/Digest/Fiscal PDF.

8) Pending-bills API smoke
   - With worker running: `curl -s http://127.0.0.1:8787/api/civic/pending-bills-with-topics | jq '.results | length'`
   - Validate: count > 0.

9) Hot-topics API smoke
   - `curl -s http://127.0.0.1:8787/api/hot-topics | jq 'length'`
   - Validate: length matches hot_topics count; no 500s.

10) Commit/update snapshot doc
    - Update `instructions/database_snapshot_12-14-25.md` with current counts and migrations once above passes.

================================================================================
FILE 2: STATUS_INGESTION_WYOLEG.md
================================================================================

# STATUS: Wyoming LSO (wyoleg.gov) Ingestion

Date: Generated locally (this-is-us repo)  
Scope: Local pipeline status (D1 local, worker dev)  

## Current State (Local)
- Source: Wyoming LSO (wyoleg.gov) pending bills (LSO/OpenStates upstream via worker).
- DB bindings: `WY_DB` (civic_items, civic_item_sources, civic_item_ai_tags, civic_item_verification, bill_sponsors); `EVENTS_DB` (hot_topics, hot_topic_civic_items).
- Local persistence: `./scripts/wr-persist`.
- Hot Topics migrations applied locally; tables exist with data (12 hot_topics, 0 junction rows).
- Resolver enabled: doc resolver resolves wyoleg PDFs (Introduced/Enroll/Digest/Fiscal, amendments) before AI analysis; writes to `civic_item_sources`.
- AI analysis: summaries + hot-topic tags via `scan-pending-bills` route; tags stored in `civic_item_ai_tags`.
- UI endpoints: `/api/civic/pending-bills-with-topics` and `/api/hot-topics` feed static JS (pending-bills.js, hot-topics.js).

## Pipeline Map (Sequence)
1) **Bill list ingestion**
   - File: `worker/src/lib/openStatesSync.mjs` (called by `runPendingBillsRefresh` in `worker/src/jobs/pendingBillsRefresh.mjs`).
   - Route/cron: `/api/dev/openstates/sync` (dev) and scheduled cron (see `wrangler.toml` cron).
   - DB: `WY_DB.civic_items`, `bill_sponsors`, `civic_item_verification`.
   - Flags: `BILL_SCANNER_ENABLED` gates scan step; OpenStates/LSO creds via env.

2) **Document resolution (wyoleg PDFs)**
   - Files: `worker/src/lib/docResolver/index.mjs`, `.../profiles/wyoleg.mjs`.
   - Templates: `{year}/Introduced|Enroll|Digest|Fiscal/{bill}.pdf`; checkpoints `/Legislation/{year}/{bill}`, `/Legislation/Amendment/{year}?billNumber={bill}` with /Amends/*.pdf parsing; SPA shell detection.
   - Route: used inside `scan-pending-bills` (below).
   - DB: `WY_DB.civic_item_sources` (best_doc_url, kind, status, checked_at, last_error).

3) **Text/Summary + Hot Topics analysis**
   - Route: `POST /api/internal/civic/scan-pending-bills` (token-gated except localhost); cron triggers `runPendingBillsRefresh`.
   - File: `worker/src/routes/civicScan.mjs` (selection, doc resolve, summary, tagging).
   - AI summary: `worker/src/lib/billSummaryAnalyzer.mjs` ‚Üí `civic_items.ai_summary`, `ai_key_points`.
   - Hot-topic tagging: `worker/src/lib/hotTopicsAnalyzer.mjs` ‚Üí `civic_item_ai_tags`; links to `EVENTS_DB.hot_topic_civic_items`.
   - Flags: `BILL_SCANNER_ENABLED=true`; auth header `X-Internal-Token` for non-local.

4) **UI consumption**
   - Pending bills: `worker/src/routes/pendingBills.mjs` ‚Üí `/api/civic/pending-bills-with-topics`; DB `WY_DB` + `EVENTS_DB`.
   - Hot topics list/detail: `worker/src/routes/hotTopics.mjs` ‚Üí `/api/hot-topics`, `/api/hot-topics/:slug`; DB `EVENTS_DB`, `WY_DB`.
   - Frontend: `static/js/civic/pending-bills.js`, `static/js/civic/hot-topics.js`.

## Tables and Columns (Key)
- `WY_DB.civic_items`: bill metadata, AI summary fields (`ai_summary`, `ai_key_points`, `ai_summary_generated_at`).
- `WY_DB.civic_item_sources`: resolved doc provenance (`civic_item_id` PK, best_doc_url, best_doc_kind, status, checked_at, last_error).
- `WY_DB.civic_item_ai_tags`: hot-topic tags (`item_id`, `topic_slug`, `confidence`, `trigger_snippet`, `reason_summary`, unique item/topic).
- `WY_DB.civic_item_verification`: verification status for pending bills.
- `WY_DB.bill_sponsors`: sponsor data tied to civic_items.
- `EVENTS_DB.hot_topics`, `EVENTS_DB.hot_topic_civic_items`: canonical topics and manual links.
- `EVENTS_DB.podcast_uploads`: unrelated to wyoleg but present.

## Endpoints and Scripts
- Routes:
  - `POST /api/internal/civic/scan-pending-bills` (doc resolve + summary + tags).
  - `GET /api/civic/pending-bills-with-topics`.
  - `GET /api/hot-topics`, `GET /api/hot-topics/:slug`.
  - Dev: `/api/dev/openstates/sync`, `/api/internal/civic/test-one`.
- Cron: `wrangler.toml` has weekly pending-bills refresh (`runPendingBillsRefresh` ‚Üí sync + scan).
- Scripts:
  - `worker/scripts/apply-migrations-local.sh` (local migrations, persist).
  - `worker/scripts/test-wyoleg-pipeline-local.sh` (end-to-end local, persist).
  - `worker/scripts/test-doc-resolver-local.sh` (resolve SF0013).
  - `worker/scripts/audit-wyoleg-ingestion.sh` (audit entrypoints, counts, schema).
  - `worker/scripts/run-civic-pipeline-local.sh`, `reset-civic-local.sh`, `verify-hot-topics-state.sh`.

## Top 10 Failure Modes (and detection)
1) Missing hot_topics tables locally ‚Üí `/api/hot-topics` 500. Detect: `./scripts/wr d1 execute EVENTS_DB --local ... SELECT name FROM sqlite_master WHERE name='hot_topics';`
2) No persistence/duplicate D1 ‚Üí data drift. Detect: `find .wrangler* -name "*.sqlite"`; ensure `--persist-to ../scripts/wr-persist`.
3) Scanner disabled ‚Üí no tags/summaries. Detect logs: ‚ÄúBILL_SCANNER_ENABLED != true‚Äù.
4) Missing token on scan endpoint ‚Üí 401. Detect: response error JSON `Unauthorized`.
5) SPA shell doc fetch (no PDF) ‚Üí civic_item_sources missing URL. Detect: query `best_doc_url IS NULL`.
6) AI summary absent ‚Üí `pending-bills-with-topics` filter hides bills. Detect: `COUNT(*) WHERE ai_summary IS NULL OR ai_summary=''`.
7) No hot_topic_civic_items links ‚Üí `/api/hot-topics` returns topics with empty civic_items. Detect: `COUNT(*) FROM hot_topic_civic_items`.
8) OpenAI env missing ‚Üí summaries/tags fail. Detect logs from `billSummaryAnalyzer` / `hotTopicsAnalyzer`.
9) Migrations not applied remotely ‚Üí schema errors. Detect: `d1_migrations` mismatch between local/remote.
10) Guardrails absent ‚Üí wrong state dir. Detect: guardrail script warnings; fix config/persist flags.

## Single Source of Truth Recommendations
- Always run local worker with `--persist-to ./scripts/wr-persist` and `XDG_CONFIG_HOME=./worker/.config`.
- Apply migrations via `./scripts/apply-migrations-local.sh` before tests.
- Treat `WY_DB` as source for bills/tags/summaries; `EVENTS_DB` for topics/links. Do not duplicate hot_topics elsewhere.
- Run `./scripts/audit-wyoleg-ingestion.sh` before commits to capture schema and counts.

================================================================================
FILE 3: worker/scripts/apply-migrations-local.sh
================================================================================

#!/usr/bin/env bash
# worker/scripts/apply-migrations-local.sh
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKER_DIR="$(dirname "$SCRIPT_DIR")"
cd "$WORKER_DIR"

PERSIST_DIR="../scripts/wr-persist"
mkdir -p "$PERSIST_DIR"

export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$WORKER_DIR/.config}"

echo "üîß Applying local migrations with --persist-to ${PERSIST_DIR}"

for DB in EVENTS_DB WY_DB; do
  echo "‚û°Ô∏è  ${DB}"
  ./scripts/wr d1 migrations apply "$DB" --local --persist-to "$PERSIST_DIR"
done

echo "‚úÖ Local migrations applied"

================================================================================
FILE 4: worker/scripts/audit-wyoleg-ingestion.sh
================================================================================

#!/usr/bin/env bash
# worker/scripts/audit-wyoleg-ingestion.sh
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKER_DIR="$(dirname "$SCRIPT_DIR")"
cd "$WORKER_DIR"

PERSIST_DIR="../scripts/wr-persist"
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$WORKER_DIR/.config}"

echo "üîé Audit: Wyoming LSO ingestion (local only)"
echo "Working dir: $WORKER_DIR"
echo "Persist dir: $PERSIST_DIR"
echo ""

report_header() {
  echo ""
  echo "=== $1 ==="
}

report_header "Entrypoints found"
rg --line-number --context 2 "scan-pending-bills|pending-bills-with-topics|hot-topics|wyoleg|LSO|Legislation/20|Amendment|SPA|civic_item_sources" worker static || true

report_header "D1 schema health"
for DB in EVENTS_DB WY_DB; do
  echo "-- $DB tables"
  ./scripts/wr d1 execute "$DB" --local --persist-to "$PERSIST_DIR" --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --json
done

report_header "Required table counts"
./scripts/wr d1 execute WY_DB --local --persist-to "$PERSIST_DIR" --command "
SELECT 'civic_items' t, COUNT(*) c FROM civic_items
UNION ALL SELECT 'civic_item_sources', COUNT(*) FROM civic_item_sources
UNION ALL SELECT 'civic_item_ai_tags', COUNT(*) FROM civic_item_ai_tags
UNION ALL SELECT 'civic_item_verification', COUNT(*) FROM civic_item_verification;
" --json
./scripts/wr d1 execute EVENTS_DB --local --persist-to "$PERSIST_DIR" --command "
SELECT 'hot_topics' t, COUNT(*) c FROM hot_topics
UNION ALL SELECT 'hot_topic_civic_items', COUNT(*) FROM hot_topic_civic_items;
" --json

report_header "Pipeline state"
./scripts/wr d1 execute WY_DB --local --persist-to "$PERSIST_DIR" --command "
SELECT 'bills_total' k, COUNT(*) v FROM civic_items
UNION ALL SELECT 'sources' , COUNT(*) FROM civic_item_sources
UNION ALL SELECT 'summaries', COUNT(*) FROM civic_items WHERE ai_summary IS NOT NULL AND ai_summary <> ''
UNION ALL SELECT 'tags', COUNT(*) FROM civic_item_ai_tags;
" --json
echo "Top topics:"
./scripts/wr d1 execute WY_DB --local --persist-to "$PERSIST_DIR" --command "
SELECT topic_slug, COUNT(*) c FROM civic_item_ai_tags GROUP BY topic_slug ORDER BY c DESC LIMIT 10;
" --json

report_header "UI integration sanity"
rg --line-number "api/civic/pending-bills-with-topics|api/hot-topics" static/js/civic || true

echo ""
echo "Next commands:"
echo "  ./scripts/apply-migrations-local.sh"
echo "  ./scripts/test-wyoleg-pipeline-local.sh --reset"
echo "  ./scripts/audit-wyoleg-ingestion.sh"
