# Quick Reference: This Is Us Project ‚Äì Testing & Improvements

## One-Page Status Summary

| Aspect | Status | Priority | Action |
|--------|--------|----------|--------|
| **Data Pipeline** | ‚úÖ Works end-to-end | ‚Äî | Automate OpenStates sync (cron job) |
| **AI Content** | ‚úÖ Summaries & matches accurate | ‚Äî | Add transparency badges ("Generated by AI") |
| **Voting** | ‚ö†Ô∏è No auth validation | **High** | Implement Firebase token validation |
| **Empty States** | ‚ö†Ô∏è Generic messaging | **High** | Add skeleton loaders + error banners |
| **Filter UX** | ‚ö†Ô∏è Dropdown hard to use | **High** | Replace with clickable chips |
| **Vote Persistence** | ‚ùå Lost on filter toggle | **High** | Store votes in localStorage |
| **Navigation** | ‚ö†Ô∏è Civic tools hidden | **Medium** | Add "Civic Watch" to global nav |
| **Mobile** | ‚úÖ Responsive cards | ‚Äî | Test filter panel on small screens |
| **Performance** | ‚úÖ <200ms local, <500ms remote | ‚Äî | Monitor OpenAI quota |

---

## Phase 1: Critical UX Improvements (Week 1)

### 1.1 Skeleton Loader on Pending Bills Page
**File**: `static/js/civic/pending-bills.js`

**Current**:
```javascript
if (els.root) {
  els.root.innerHTML = `<div class="empty-state">Loading bills...</div>`;
}
```

**Improve to**:
```javascript
if (els.root) {
  els.root.innerHTML = `
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  `;
}
```

**CSS** (add to `layouts/civic/pending-bills.html`):
```css
.skeleton-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 1.25rem;
  background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
  height: 200px;
}
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
```

### 1.2 Vote Feedback & Persistence
**File**: `static/js/civic/pending-bills.js`

**Add**:
```javascript
// Store vote in localStorage
function voteOnBill(billId, value) {
  localStorage.setItem(`vote_${billId}`, value);
  fetch(`/api/civic/items/${billId}/vote`, {
    method: 'POST',
    body: JSON.stringify({user_id: window.currentUser.uid, value})
  })
  .then(() => {
    button.textContent = "‚úÖ Vote recorded";
    setTimeout(() => { button.textContent = originalText; }, 1500);
  })
  .catch(err => button.textContent = "‚ö†Ô∏è Error");
}

// On page load, highlight user's previous votes
function highlightUserVotes() {
  document.querySelectorAll('[data-bill-id]').forEach(el => {
    const billId = el.dataset.billId;
    const userVote = localStorage.getItem(`vote_${billId}`);
    if (userVote === 'up') el.classList.add('voted-up');
    if (userVote === 'down') el.classList.add('voted-down');
  });
}
```

### 1.3 "Generated by AI" Transparency
**File**: `layouts/civic/pending-bills.html`

**Replace** bill summary rendering to include badge:
```html
<div class="summary-block">
  <div class="summary-label">
    Plain summary 
    <span class="ai-badge">‚ú® AI-generated</span>
  </div>
  <div class="summary-text">${escapeHtml(bill.ai_plain_summary)}</div>
  <div class="summary-meta">
    <small>üîó <a href="${bill.external_url}" target="_blank">View full text</a></small>
  </div>
</div>
```

**CSS**:
```css
.ai-badge {
  display: inline-block;
  background: #f0e6ff;
  color: #6d28d9;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 0.5rem;
}
```

### 1.4 Confidence Tooltip + Trigger Snippet
**File**: `layouts/civic/pending-bills.html`

**Replace** confidence rendering:
```html
<span class="text-xs text-gray-500" title="AI matched this bill with confidence. Why?">
  confidence ${confidence} <span class="info-icon">‚ìò</span>
</span>

<!-- Show trigger snippet as visual proof -->
<div class="snippet" style="background: #f9fafb; border-left: 3px solid #6366f1; padding-left: 0.75rem; margin: 0.5rem 0; font-style: italic; color: #4b5563;">
  "${escapeHtml(topic.trigger_snippet)}"
</div>
```

### 1.5 Login Status Indicator
**File**: `layouts/civic/pending-bills.html`

**Add** near top of pending bills section:
```html
<div style="margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px;">
  <small style="color: #059669;">
    ‚úì Logged in as <strong>{{ user_email }}</strong> 
    <a href="/account/logout" style="margin-left: 0.5rem;">Sign out</a>
  </small>
</div>
```

(Pass `user_email` from Hugo context if available, or detect from Firebase in JavaScript)

---

## Phase 2: Filter & Navigation Improvements (Week 2)

### 2.1 Topic Chips Instead of Dropdown
**File**: `layouts/civic/pending-bills.html`

**Replace**:
```html
<label>
  <span>Show bills about</span>
  <select id="pending-topic-filter">
    <option value="all">All topics</option>
    <!-- Populated by JS -->
  </select>
</label>
```

**With**:
```html
<div class="filter-chips">
  <span class="filter-label">Show bills about:</span>
  <div id="topic-chips" class="chips-container">
    <!-- Populated by JS: [Property Taxes] [Water Rights] [Education] ... -->
  </div>
</div>
```

**JavaScript** (`pending-bills.js`):
```javascript
function renderTopicChips(topics) {
  const container = document.getElementById('topic-chips');
  const allChip = `<button class="chip active" data-topic="all">All topics</button>`;
  const topicChips = topics
    .map(t => `<button class="chip" data-topic="${escapeHtml(t.slug)}">
      <span class="badge">${escapeHtml(t.badge)}</span>
      ${escapeHtml(t.title)} (${getBillCountForTopic(t.slug)})
    </button>`)
    .join('');
  container.innerHTML = allChip + topicChips;
  
  container.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      state.topic_slug = chip.dataset.topic;
      updateChipStates();
      refresh();
    });
  });
}

function updateChipStates() {
  document.querySelectorAll('.chip').forEach(chip => {
    if (chip.dataset.topic === state.topic_slug) {
      chip.classList.add('active');
    } else {
      chip.classList.remove('active');
    }
  });
}
```

**CSS**:
```css
.filter-chips {
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}
.filter-label {
  font-weight: 600;
  color: #111827;
}
.chips-container {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.chip {
  border: 2px solid #e5e7eb;
  background: white;
  color: #374151;
  padding: 0.5rem 0.75rem;
  border-radius: 9999px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.15s ease;
  display: flex;
  gap: 0.35rem;
  align-items: center;
}
.chip:hover {
  border-color: #6366f1;
  color: #6366f1;
}
.chip.active {
  background: #eef2ff;
  border-color: #6366f1;
  color: #6366f1;
}
.chip .badge {
  display: inline-block;
  background: #f3f4f6;
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
  font-size: 0.75rem;
}
```

### 2.2 "Civic Watch" Global Nav
**File**: `layouts/partials/header.html`

**Add** to main navigation:
```html
<li class="nav-item">
  <span class="nav-label">Civic Watch</span>
  <ul class="nav-submenu">
    <li><a href="/hot-topics/">Hot Topics</a></li>
    <li><a href="/civic/pending/">Pending Bills</a></li>
    <!-- <li><a href="/town-halls/">Town Halls</a></li> (future) -->
  </ul>
</li>
```

### 2.3 Bill Count Badges on Filters
**File**: `pending-bills.js`

**Enhance dropdowns to show counts**:
```javascript
function syncSessionOptions(bills) {
  const sessions = Array.from(
    new Set(bills.map(b => b.legislative_session).filter(Boolean))
  );
  
  const billsBySession = {};
  bills.forEach(b => {
    billsBySession[b.legislative_session] = (billsBySession[b.legislative_session] || 0) + 1;
  });
  
  const options = [`<option value="">All sessions (${bills.length})</option>`].concat(
    sessions.map(s => `<option value="${s}">${s} (${billsBySession[s]})</option>`)
  );
  els.session.innerHTML = options.join("");
}
```

---

## Phase 3: Data Automation (Ops Priority)

### 3.1 Daily OpenStates Sync (Cron Job)
**File**: `wrangler.toml`

**Add**:
```toml
[[triggers.crons]]
cron = "0 8 * * *"  # Daily at 8 AM UTC
```

**File**: `worker/src/index.mjs`

**Add handler**:
```javascript
export default {
  async fetch(request, env) {
    // Existing routes
  },
  async scheduled(event, env) {
    console.log("üïê Scheduled job triggered (daily sync)");
    try {
      const bills = await openStatesSync.fetchBills(env, "2025");
      await openStatesSync.upsertCivicItems(env, bills);
      console.log(`‚úÖ Synced ${bills.length} bills from OpenStates`);
      
      // Also trigger topic analysis for new bills
      await civicScan.scanPendingBills(env);
      console.log("‚úÖ Analyzed bills for hot topic matches");
    } catch (err) {
      console.error("‚ùå Scheduled job failed:", err);
    }
  }
}
```

### 3.2 Firebase Auth for Voting
**File**: `worker/src/routes/civicVotes.mjs`

**Update vote handler**:
```javascript
export async function handleVoteCivicItem(request, env) {
  try {
    // 1. Extract & validate Firebase ID token
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return new Response(JSON.stringify({error: 'Unauthorized'}), {status: 401});
    }
    
    const idToken = authHeader.split(' ')[1];
    const decodedToken = await admin.auth().verifyIdToken(idToken);
    const userId = decodedToken.uid;
    
    // 2. Parse request body
    const {target_id, value} = await request.json();
    
    // 3. Validate value (-1, 0, or 1)
    if (![1, -1, 0].includes(value)) {
      return new Response(JSON.stringify({error: 'Invalid vote value'}), {status: 400});
    }
    
    // 4. Insert or update vote (enforce one vote per user per bill)
    await env.WY_DB.prepare(`
      INSERT INTO votes (id, target_type, target_id, user_id, value, created_at)
      VALUES (?, 'civic_item', ?, ?, ?, datetime('now'))
      ON CONFLICT(user_id, target_id) DO UPDATE SET value = ?
    `).bind(crypto.randomUUID(), target_id, userId, value, value).run();
    
    // 5. Return updated vote counts
    const {results: [counts]} = await env.WY_DB.prepare(`
      SELECT 
        SUM(CASE WHEN value=1 THEN 1 ELSE 0 END) as up_votes,
        SUM(CASE WHEN value=-1 THEN 1 ELSE 0 END) as down_votes,
        SUM(CASE WHEN value=0 THEN 1 ELSE 0 END) as info_votes
      FROM votes WHERE target_id = ?
    `).bind(target_id).first();
    
    return new Response(JSON.stringify({...counts, success: true}), {status: 200});
  } catch (err) {
    console.error("‚ùå Vote error:", err);
    return new Response(JSON.stringify({error: err.message}), {status: 500});
  }
}
```

**Client-side update** (`pending-bills.js`):
```javascript
// Get Firebase ID token and include in vote request
async function voteOnBill(billId, value) {
  const idToken = await firebase.auth().currentUser.getIdToken();
  
  const res = await fetch(`/api/civic/items/${billId}/vote`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${idToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({target_id: billId, value})
  });
  
  if (!res.ok) {
    console.error("Vote failed:", await res.json());
    return;
  }
  
  const {up_votes, down_votes, info_votes} = await res.json();
  updateVoteDisplay(billId, up_votes, down_votes, info_votes);
}
```

---

## Testing Checklist (All Phases)

### Before Merge
- [ ] All 5 test bills load on `/civic/pending/`
- [ ] Filters (topic, session, chamber, status) work individually and combined
- [ ] Vote buttons increment and persist across page reloads
- [ ] Copy-to-clipboard works on Chrome, Firefox, Safari
- [ ] Mobile: filters fit; cards don't overflow; readable text
- [ ] Keyboard: Tab through filters; focus states visible
- [ ] Console: No JavaScript errors

### After Phase 1 Deployed
- [ ] Skeleton loader animates while fetching bills
- [ ] Vote feedback shows ("‚úÖ Vote recorded")
- [ ] "Generated by AI" badge visible on summaries
- [ ] Confidence tooltip shows when hovering
- [ ] "View full bill text" link works
- [ ] Login status indicator shows user email

### After Phase 2 Deployed
- [ ] Topic chips display instead of dropdown
- [ ] Bill counts visible on chips ("Property Taxes (23)")
- [ ] Clicking chip filters bills correctly
- [ ] "Civic Watch" visible in global nav
- [ ] Hot Topics CTA links to filtered pending bills

### After Phase 3 Deployed
- [ ] Cron job runs daily at 8 AM UTC (check logs)
- [ ] New bills appear automatically (no manual sync)
- [ ] Vote requires Firebase auth (test spoofed user_id in console ‚Äì should fail)
- [ ] One vote per user enforced (vote again on same bill ‚Äì should update not duplicate)

---

## Cost & Performance Targets

| Metric | Target | Current | Note |
|--------|--------|---------|------|
| Pending bills API latency | <500ms | <200ms local | Good |
| OpenAI cost per bill | <$0.001 | $0.0008‚Äì$0.0011 | Summary + topic analysis |
| OpenAI daily cost (100 bills) | <$0.10 | ~$0.10 | Affordable |
| D1 query time (100 bills) | <200ms | <200ms local | Good |
| Page load (Pending Bills) | <2s | <1s local | Good |
| Vote latency | <500ms | <100ms local | Good |

---

## Deployment Checklist

- [ ] Phase 1 improvements tested on staging
- [ ] Firebase auth endpoints verified
- [ ] OpenStates API key valid
- [ ] OpenAI quota sufficient (check dashboard)
- [ ] CORS headers configured (if deploying to production domain)
- [ ] Rate limiting in place for `/api/internal/*` endpoints
- [ ] Monitoring/alerting configured for OpenAI quota
- [ ] Documentation updated for ops team
- [ ] User testing scheduled with Wyoming residents

---

**Last Updated**: December 6, 2025  
**Next Review**: After Phase 1 deployment (Week 1)
